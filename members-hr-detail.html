<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOX VENATIR - Espace Membre</title>
  <link rel="stylesheet" href="styles.css"> <!-- Assurez-vous que ce fichier existe -->
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="journal.html">Journal de bord</a></li>
        <li><a href="members-hr-detail.html">Fiche RH</a></li>
        <li><a href="missions.html">Missions</a></li>
        <li><a href="tactique.html">Tactique NOX</a></li>
        <li><a href="#" id="logout">Déconnexion</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="member-details">
      <h2>Détails Membre</h2>
      <div class="member-content">
        <div class="video-container">
          <video id="member-video" controls>
            <source id="video-source" src="" type="video/mp4">
          </video>
          <div id="video-error" class="video-error" style="display: none;">
            Erreur : Vidéo non disponible. Vérifiez le chemin dans Firestore.
          </div>
        </div>

        <div class="member-info">
          <label for="race">Race</label>
          <input type="text" id="race" placeholder="Entrez la race">

          <label for="age">Âge</label>
          <input type="text" id="age" placeholder="Entrez l'âge">

          <label for="origin">Origine</label>
          <input type="text" id="origin" placeholder="Entrez l'origine">

          <label for="role">Rôle</label>
          <input type="text" id="role" placeholder="Entrez le rôle">

          <label for="missions-count">Nombre de missions</label>
          <span id="missions-count">0 mission(s)</span>

          <label for="miscInfo">Informations diverses</label>
          <textarea id="miscInfo" placeholder="Entrez des informations supplémentaires"></textarea>

          <button id="save-button">Enregistrer</button>
        </div>

        <div class="actions">
          <button onclick="document.getElementById('medal-modal').style.display='block'">Ajouter une Médaille</button>
        </div>

        <div class="medals-section">
          <h3>Médailles</h3>
          <div id="medals-list"></div>
        </div>

        <div class="missions-section">
          <h3>Missions</h3>
          <div id="missions-list"></div>
        </div>
      </div>
    </section>

    <!-- Modal pour ajouter une médaille -->
    <div id="medal-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="document.getElementById('medal-modal').style.display='none'">&times;</span>
        <h3>Ajouter une Médaille</h3>
        <label for="medal-name">Nom de la médaille</label>
        <input type="text" id="medal-name" placeholder="Nom de la médaille">
        <label for="medal-date">Date d'obtention</label>
        <input type="date" id="medal-date">
        <label for="medal-description">Description</label>
        <textarea id="medal-description" placeholder="Description de la médaille"></textarea>
        <label for="medal-image">Image de la médaille</label>
        <input type="file" id="medal-image" accept="image/*">
        <button onclick="addMedal()">Ajouter</button>
      </div>
    </div>
  </main>

  <footer>
    <p>© 2955 NOX VENATIR. Tous droits réservés. Hunt the stars, citizen.</p>
  </footer>

  <script>
    // Configuration Firebase (remplacez par vos propres valeurs)
    const firebaseConfig = {
      apiKey: "VOTRE_API_KEY",
      authDomain: "VOTRE_PROJET.firebaseapp.com",
      projectId: "VOTRE_PROJET",
      storageBucket: "VOTRE_PROJET.appspot.com",
      messagingSenderId: "VOTRE_SENDER_ID",
      appId: "VOTRE_APP_ID"
    };

    // Initialiser Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Références aux éléments HTML
    const raceInput = document.getElementById('race');
    const ageInput = document.getElementById('age');
    const originInput = document.getElementById('origin');
    const roleInput = document.getElementById('role');
    const miscInfoInput = document.getElementById('miscInfo');
    const saveButton = document.getElementById('save-button');
    const missionsCountSpan = document.getElementById('missions-count');
    const missionsList = document.getElementById('missions-list');
    const medalsList = document.getElementById('medals-list');
    const videoElement = document.getElementById('member-video');
    const videoSource = document.getElementById('video-source');
    const videoError = document.getElementById('video-error');
    const logoutLink = document.getElementById('logout');

    // Charger les données utilisateur
    function loadUserData() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          const userId = user.uid;
          const userRef = db.collection('users').doc(userId);

          // Charger les données utilisateur
          userRef.get().then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              raceInput.value = data.race || '';
              ageInput.value = data.age || '';
              originInput.value = data.origin || '';
              roleInput.value = data.role || '';
              miscInfoInput.value = data.miscInfo || '';

              // Charger la vidéo
              if (data.videoUrl) {
                videoSource.src = data.videoUrl;
                videoElement.load();
                videoError.style.display = 'none';
              } else {
                videoError.style.display = 'block';
              }
            } else {
              console.log('Aucun document utilisateur trouvé.');
            }
          }).catch((error) => {
            console.error('Erreur lors du chargement des données :', error);
          });

          // Charger les missions
          loadMissions(userId);
          // Charger les médailles
          loadMedals(userId);
        } else {
          console.error('Utilisateur non connecté.');
          window.location.href = 'login.html'; // Rediriger vers la page de connexion
        }
      });
    }

    // Charger les missions (tri décroissant par titre)
    function loadMissions(userId) {
      const missionsRef = db.collection('users').doc(userId).collection('missions');
      missionsRef.orderBy('title', 'desc').get().then((querySnapshot) => {
        missionsList.innerHTML = ''; // Vider la liste
        const missionsArray = [];

        querySnapshot.forEach((doc) => {
          missionsArray.push({ id: doc.id, ...doc.data() });
        });

        // Afficher les missions
        missionsArray.forEach((mission) => {
          const missionDiv = document.createElement('div');
          missionDiv.className = 'mission-item';
          missionDiv.innerHTML = `
            <h4>${mission.title || 'Mission sans titre'}</h4>
            <p>${mission.description || ''}</p>
            ${mission.imageUrl ? `<img src="${mission.imageUrl}" alt="Aperçu" style="max-width: 200px;">` : ''}
            <small>ID: ${mission.id}</small>
          `;
          missionsList.appendChild(missionDiv);
        });

        // Mettre à jour le compteur
        missionsCountSpan.textContent = `${missionsArray.length} mission(s)`;
      }).catch((error) => {
        console.error('Erreur lors du chargement des missions :', error);
        missionsList.innerHTML = '<p>Erreur de chargement des missions.</p>';
      });
    }

    // Charger les médailles
    function loadMedals(userId) {
      const medalsRef = db.collection('users').doc(userId).collection('medals');
      medalsRef.get().then((querySnapshot) => {
        medalsList.innerHTML = ''; // Vider la liste
        querySnapshot.forEach((doc) => {
          const medal = doc.data();
          const medalDiv = document.createElement('div');
          medalDiv.className = 'medal-item';
          medalDiv.innerHTML = `
            <h4>${medal.name || 'Médaille sans nom'}</h4>
            <p>Date: ${medal.date || ''}</p>
            <p>${medal.description || ''}</p>
            ${medal.imageUrl ? `<img src="${medal.imageUrl}" alt="Médaille" style="max-width: 100px;">` : ''}
          `;
          medalsList.appendChild(medalDiv);
        });
      }).catch((error) => {
        console.error('Erreur lors du chargement des médailles :', error);
        medalsList.innerHTML = '<p>Erreur de chargement des médailles.</p>';
      });
    }

    // Enregistrer les données utilisateur
    function saveUserData() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          const userId = user.uid;
          const userRef = db.collection('users').doc(userId);
          const updatedData = {
            race: raceInput.value.trim(),
            age: ageInput.value.trim(),
            origin: originInput.value.trim(),
            role: roleInput.value.trim(),
            miscInfo: miscInfoInput.value.trim()
          };

          saveButton.disabled = true;
          userRef.set(updatedData, { merge: true }).then(() => {
            alert('Données enregistrées avec succès !');
            saveButton.disabled = false;
          }).catch((error) => {
            console.error('Erreur lors de l\'enregistrement :', error);
            alert('Erreur lors de l\'enregistrement.');
            saveButton.disabled = false;
          });
        } else {
          alert('Vous devez être connecté pour enregistrer.');
        }
      });
    }

    // Ajouter une médaille
    function addMedal() {
      const name = document.getElementById('medal-name').value.trim();
      const date = document.getElementById('medal-date').value;
      const description = document.getElementById('medal-description').value.trim();
      const image = document.getElementById('medal-image').files[0];

      if (!name || !date) {
        alert('Nom et date de la médaille requis.');
        return;
      }

      auth.onAuthStateChanged((user) => {
        if (user) {
          const userId = user.uid;
          const medalsRef = db.collection('users').doc(userId).collection('medals').doc();
          const medalData = { name, date, description };

          // Gérer l'upload d'image si présente
          if (image) {
            // À implémenter : upload vers Firebase Storage et récupérer imageUrl
            // Exemple : storageRef.put(image).then(() => ...)
            console.log('Upload image non implémenté. Ajoutez Firebase Storage.');
          }

          medalsRef.set(medalData).then(() => {
            document.getElementById('medal-modal').style.display = 'none';
            document.getElementById('medal-name').value = '';
            document.getElementById('medal-date').value = '';
            document.getElementById('medal-description').value = '';
            document.getElementById('medal-image').value = '';
            loadMedals(userId); // Recharger les médailles
          }).catch((error) => {
            console.error('Erreur lors de l\'ajout de la médaille :', error);
            alert('Erreur lors de l\'ajout de la médaille.');
          });
        }
      });
    }

    // Déconnexion
    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    });

    // Charger les données au démarrage
    loadUserData();

    // Écouter le bouton Enregistrer
    saveButton.addEventListener('click', saveUserData);
  </script>

  <style>
    /* CSS minimal pour rendre la page fonctionnelle */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1a1a1a;
      padding: 10px;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }
    nav a {
      color: white;
      text-decoration: none;
    }
    .member-details {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .member-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .video-container, .member-info, .medals-section, .missions-section {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
    }
    .member-info label {
      display: block;
      margin: 10px 0 5px;
    }
    .member-info input, .member-info textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    .member-info button {
      background: #007bff;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }
    .mission-item, .medal-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
      max-width: 500px;
      width: 100%;
    }
    .modal-content .close {
      float: right;
      cursor: pointer;
    }
    footer {
      text-align: center;
      padding: 20px;
      background: #1a1a1a;
      color: white;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
  </style>
</body>
</html>
